name: MultiMC5-Release

on:
  push:
    branches:
      - develop
      - stable
      - CI
  pull_request:
    branches:
      - master
      - releases
      - CI

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [windows-latest]
        
    steps:
      - name: Context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1
      
      - name: Creates QtAccount File
        uses: DamianReeves/write-file-action@v1.0
        with:
          # The path to the file to write
          path: "%APPDATA%\\Qt"
          # The contents of the file
          contents: ${{ secrets.QTACCOUNT }}
                    
      - name: Echo and PWD test
        shell: cmd
        run: echo "%APPDATA%\\Qt"
          
      - name: Cache
        uses: actions/cache@v2.1.5
        id: installer-cached
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: "installer.exe"
          # An explicit key for restoring and saving the cache
          key: ${{ runner.os }}-qt56-installer

      - name: Cache Qt
        uses: actions/cache@v2.1.5
        id: qt-cached
        with:
          # A list of files, directories, and wildcard patterns to cache and restore
          path: "C:/Users/runneradmin/Qt"
          # An explicit key for restoring and saving the cache
          key: ${{ runner.os }}-qt56-installed

      - name: Download Qt Installer
        if: steps.installer-cached.outputs.cache-hit != 'true' && steps.qt-cached.outputs.cache-hit != 'true'
        run: |
          curl https://download.qt.io/new_archive/qt/5.6/5.6.3/qt-opensource-windows-x86-mingw492-5.6.3.exe --output installer.exe
          
      - name: Download Qt non-Interactive Script
        run: |
          curl https://gist.githubusercontent.com/PibePlayer/cf6bd0a9f7e4d51e3e618ceedfba4b94/raw/3c31c42844a8dc4be79f3ca87a63d30a8982dbef/qt-installer-noninteractive.qs --output nonInteractive.qs
        
      - name: Install Qt 5.6.3
        if: steps.qt-cached.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          installer.exe -v --script nonInteractive.qs --silent
